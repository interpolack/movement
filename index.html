<html>
<script src='js/d3.js'></script>
<script src='js/queue.js'></script>
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  font-family: 'Helvetica Neue';
  text-transform: uppercase;
  font-size: 8px;
  letter-spacing: 0.5px;
  overflow: none;
}
.movement {
  cursor: pointer;
}
.movement.highlighted {
  opacity: 1;
}
.movement.highlighted .shell {
  visibility: visible;
}
.movement.highlighted .label {
  visibility: visible;
}
.article {
  cursor: pointer;
}
.article.highlighted {
  opacity: 1;
}
</style>
<body>
</body>
<script>

var width = window.innerWidth
var height = window.innerHeight

var mouse = [0,0]

var svg = d3.select('body').append('svg')
  .attr('width', width)
  .attr('height', height)
  .on('mousemove', function(){
    mouse = d3.mouse(this)
  })
var layer1 = svg.append('g')
var layer2 = svg.append('g')
var layer3 = svg.append('g')

var dates = 146.0

var trend = d3.svg.line()
  .interpolate('cardinal')
  .x(function(d,i){ return i / dates * width })
  .y(function(d){ return height - d - 20 })

var dateToValue = function(date) {
  var split = date.split("/")
  return ((parseInt(split[2] - 4) * 12) + parseInt(split[0]))
}

var months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"]

var colors = d3.scale.category20b()

window.onresize = function() {
  width = window.innerWidth
  height = window.innerHeight
}

queue(1)
  .defer(d3.json, 'data/movements.json')
  .defer(d3.json, 'data/points.json')
  .defer(d3.json, 'data/trends.json')
  .awaitAll(function(error, results){
    var movements = results[0]
    var points = results[1]
    var trends = results[2]

    var movement = layer2.selectAll('.movement')
      .data(movements)
    var movementEnter = movement
      .enter()
      .append('g')
      .attr('transform', function(d,i){ return 'translate(' + (1000 - (450 + points[d.name][1] * 250)) + ',' + (300 + points[d.name][0] * 50) + ')'})
      .attr('class', function(d){
        var keywords = {}
        d.values.map(function(value, j){
          value.keywords.map(function(keyword, k){
            var key = keyword.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()\s"'|]/g,"").toLowerCase()
            if (keywords[key] == null) keywords[key] = 1
            else keywords[key] ++
          })
        })
        var keys = []
        for (var key in keywords) {
          if (keywords[key] > 10) keys.push(key)
        }
        return 'movement ' + keys.join(' ')
      })
      .on('click', function(d,i){
        var self = d3.select(this)
        var locked = d3.select(this).classed('locked')
        self.classed('locked', !locked)
        d3.selectAll('.trend.trend' + i).classed('locked', !locked)
        d3.selectAll('.article').classed('highlighted', false)
        d3.selectAll('.article.article' + i).classed('locked', !locked)
      })
      .on('mouseover', function(movement,m){

        d3.selectAll('.movement').attr('opacity', 0.1)
        d3.select(this).classed('highlighted', true)

        layer1.append('path')
          .attr('opacity', 1)
          .attr('stroke-width', 5)
          .attr('stroke', '#666')
          .attr('fill', 'none')
          .attr('d', trend(trends[movement.name]))
          .attr('class', 'trend trend' + m)
        layer1.selectAll('.tick')
          .data([5,6,7,8,9,10,11,12,13,14,15,16])
          .enter()
          .append('text')
          .text(function(d){ return 2000 + d })
          .attr('y', function(d){ return height - 5 })
          .attr('x', function(d,i){ return -10 + i / 11.3 * width })
          .attr('class', 'tick')

        var article = layer2.selectAll('.article' + m)
          .data(movement.values)
        var articleEnter = article.enter().append('g')
          .attr('transform', function(d){ return 'translate(' + ((dateToValue(d.date) - 1) / dates * width) + ',0)'})
          .attr('class', function(d){ return 'article article' + m + ' d' + dateToValue(d.date)})
          .on('mouseover', function(blot,k){
            d3.selectAll('.trend,.article,.movement:not(.locked)').attr('opacity', 0.1).classed('highlighted', false)
            d3.select(this).attr('opacity', 1)
            var keyword = d3.select(this).selectAll('.keyword')
              .data(blot.keywords)
            var keywordEnter = keyword.enter().append('g')
            keywordEnter.append('text')
              .text(function(){
                var date = blot.date
                var split = date.split('/')
                return months[parseInt(split[0]) - 1] + "/20" + split[2]
              })
              .attr('x', function(){
                if (mouse[0] > width / 2) return -10
                return 10
              })
              .attr('text-anchor', function(){
                if (mouse[0] > width / 2) return 'end'
                return 'start'
              })
              .attr('font-weight', 700)
              .attr('y', function(d,i){ return -8 -20 + height - trends[movement.name][dateToValue(blot.date) - 1] })
              .attr('class', 'keyword')
            keywordEnter.append('text')
              .text(function(d){ return d })
              .attr('x', function(){
                if (mouse[0] > width / 2) return -10
                return 10
              })
              .attr('text-anchor', function(){
                if (mouse[0] > width / 2) return 'end'
                return 'start'
              })
              .attr('y', function(d,i){ return -20 + height - trends[movement.name][dateToValue(blot.date) - 1] + (i * 8) })
              .attr('class', 'keyword')

            if (blot.keywords == 0) return
            var classes = []
            blot.keywords.map(function(keyword,k){
              classes.push(keyword.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()\s"'|]/g,"").toLowerCase())
            })
            classes = classes.join(',.')
            d3.selectAll('.' + classes + ',.d' + dateToValue(blot.date)).classed('highlighted', true)
          })
          .on('mouseout', function(blot,k){
            d3.selectAll('.trend,.article,.movement').attr('opacity', 1)
            d3.selectAll('.keyword').remove()
            d3.selectAll('.movement:not(.locked)').classed('highlighted', false)
          })
        articleEnter.append('rect')
          .filter(function(d){ return d.ny_count > 0  })
          .attr('x', -5)
          .attr('y', function(d,i){ return -20 + height - trends[movement.name][dateToValue(d.date) - 1] - ((Math.sqrt(d.ny_count) * 5 > 10 ? Math.sqrt(d.ny_count) * 5 : 10) / 2) })
          .attr('width', 10)
          .attr('height', function(d){ return Math.sqrt(d.ny_count) * 5 > 10 ? Math.sqrt(d.ny_count) * 5 : 10  })
          .attr('rx', 5)
          .attr('fill', function(d){ return 'rgb(' + parseInt(Math.abs(d.sentiment - 1) * 255) + ',' + parseInt((1 - Math.abs(d.sentiment)) * 255) + ',' + parseInt(Math.abs(d.sentiment + 1) * 255) + ')' })
          .attr('stroke', '#666')
          .attr('stroke-width', 3)

        var classes = d3.select(this).attr('class').split(' ')
        classes.shift()
        if (classes.length == 1) return
        classes = classes.join(',.')
        d3.selectAll('.' + classes).classed('highlighted', true)

      })
      .on('mouseout', function(d){
        d3.selectAll('.tick,.trend:not(.locked),.article:not(.locked)').remove()
        d3.selectAll('.movement:not(.locked)').classed('highlighted', false).attr('opacity', 1)
      })
    movementEnter.append('circle')
      .attr('r', 9)
      .attr('stroke-width', 3)
      .attr('stroke', '#666')
      .attr('fill', 'none')
      .attr('visibility', 'hidden')
      .attr('class', 'shell')
    movementEnter.append('text')
      .text(function(d){ return d.name })
      .attr('x', 15)
      .attr('visibility', 'hidden')
      .attr('class', 'label')
    movementEnter.each(function(movement, i) {
      var ripples = d3.select(this).selectAll('.ripple')
        .data(movement.values)
      ripples.enter()
        .append('circle')
        .attr('r', function(d){ return dateToValue(d.date) / 20.0 })
        .attr('opacity', function(d){ return d.google_trend_count / 2000.0 })
        .attr('stroke-width', 1)
        .attr('stroke', function(d){ return d.sentiment < 0 ? 'rgb(255,100,50)' : 'rgb(50,100,255)' })
        .attr('fill', 'none')
    })

  })
</script>
</html>
