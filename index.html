<html>
<script src='js/d3.js'></script>
<script src='js/queue.js'></script>
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  font-family: 'Helvetica Neue';
  text-transform: uppercase;
  font-size: 8px;
  letter-spacing: 0.5px;
}
.movement {
  cursor: pointer;
}
</style>
<body>
</body>
<script>

var width = window.innerWidth
var height = window.innerHeight

var svg = d3.select('body').append('svg')
  .attr('width', width)
  .attr('height', height)

var trend = d3.svg.line()
  .interpolate('basis')
  .x(function(d,i){ return i / 146.0 * width })
  .y(function(d){ return 800 - d })

queue(1)
  .defer(d3.json, 'data/movements.json')
  .defer(d3.json, 'data/points.json')
  .defer(d3.json, 'data/trends.json')
  .awaitAll(function(error, results){
    var movements = results[0]
    var points = results[1]
    var trends = results[2]

    console.log(movements)

    var movement = svg.selectAll('.movement')
      .data(movements)
    var movementEnter = movement
      .enter()
      .append('g')
      .attr('transform', function(d,i){ return 'translate(' + (1000 - (450 + points[d.name][1] * 250)) + ',' + (300 + points[d.name][0] * 50) + ')'})
      .attr('class', function(d){
        var keywords = {}
        d.values.map(function(value, j){
          value.keywords.map(function(keyword, k){
            var key = keyword.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()\s"'|]/g,"").toLowerCase()
            if (keywords[key] == null) keywords[key] = 1
            else keywords[key] ++
          })
        })
        var keys = []
        for (var key in keywords) {
          if (keywords[key] > 10) keys.push(key)
        }
        return 'movement ' + keys.join(' ')
      })
      .on('mouseover', function(d){

        d3.select(this).selectAll('.shell,.label')
          .attr('visibility', 'visible')

        d3.selectAll('.trend').remove()
        svg.append('path')
          .attr('stroke-width', 10)
          .attr('stroke', '#eee')
          .attr('fill', 'none')
          .attr('d', trend(trends[d.name]))
          .attr('class', 'trend')

        var classes = d3.select(this).attr('class').split(' ')
        classes.shift()
        if (classes.length == 1) return
        classes = classes.join(',.')
        d3.selectAll('.' + classes)
          .selectAll('.shell,.label')
          .attr('visibility', 'visible')

      })
      .on('mouseout', function(d){
        d3.selectAll('.shell,.label').attr('visibility', 'hidden')
      })
    movementEnter.append('circle')
      .attr('r', 6.5)
      .attr('stroke-width', 1)
      .attr('stroke', '#000')
      .attr('fill', 'none')
      .attr('visibility', 'hidden')
      .attr('class', 'shell')
    movementEnter.append('text')
      .text(function(d){ return d.name })
      .attr('x', 10)
      .attr('visibility', 'hidden')
      .attr('class', 'label')
    movementEnter.each(function(movement, i) {
      var ripples = d3.select(this).selectAll('.ripple')
        .data(movement.values)
      ripples.enter()
        .append('circle')
        .attr('r', function(d){
          var split = d.date.split("/")
          return ((parseInt(split[2] - 4) * 12) + parseInt(split[0])) / 25.0
        })
        .attr('opacity', function(d){ return d.google_trend_count / 5000.0 })
        .attr('stroke-width', 1)
        .attr('stroke', function(d){
          return d.sentiment < 0 ? 'rgb(255,0,0)' : 'rgb(0,0,155)'
        })
        .attr('fill', 'none')
    })

  })
</script>
</html>
